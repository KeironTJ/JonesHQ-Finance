{% extends "base.html" %}

{% block title %}Work Expenses{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Work Expenses</h1>
        <!-- Info Popover about Expense Workflow -->
        <button type="button"
                class="btn btn-link p-0 mb-3 text-muted"
                data-bs-toggle="popover"
                data-bs-trigger="focus"
                data-bs-placement="bottom"
                data-bs-html="true"
                data-bs-title="<i class='bi bi-info-circle'></i> Expense Workflow"
                data-bs-content="<ol class='mb-0 ps-3'><li><strong>Payment:</strong> When expense entered → Creates Credit Card or Bank transaction</li><li><strong>Reimbursement:</strong> All submitted expenses for period → Single reimbursement on last working day</li><li><strong>CC Payment:</strong> 1 working day after reimbursement → Auto payment to clear credit cards</li></ol>"
                title="How this works">
            <i class="bi bi-info-circle fs-5"></i>
        </button>
        <div class="d-flex gap-2">
            <a href="{{ url_for('settings.index') }}" class="btn btn-outline-secondary btn-sm" title="Configure expense accounts and settings">
                <i class="bi bi-gear"></i> Settings
            </a>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#generateAllModal" title="Sync reimbursements and CC payments">
                <i class="bi bi-arrow-repeat"></i> Sync Transactions
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                <i class="bi bi-plus-circle"></i> Add Expense
            </button>
            <a href="{{ url_for('transactions.index') }}" class="btn btn-secondary">Back to Transactions</a>
        </div>
    </div>



    <div class="card mb-4">
        <div class="card-body p-2">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <option value="Fuel" {% if selected_type == 'Fuel' %}selected{% endif %}>Fuel</option>
                        <option value="Hotel" {% if selected_type == 'Hotel' %}selected{% endif %}>Hotel</option>
                        <option value="Food" {% if selected_type == 'Food' %}selected{% endif %}>Food</option>
                        <option value="VAT" {% if selected_type == 'VAT' %}selected{% endif %}>VAT</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vehicle</label>
                    <select name="vehicle" class="form-select" onchange="this.form.submit()">
                        <option value="">All Vehicles</option>
                        {% for v in vehicles %}
                        <option value="{{ v.registration }}" {% if selected_vehicle == v.registration %}selected{% endif %}>{{ v.registration }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Reimbursed</label>
                    <select name="reimbursed" class="form-select" onchange="this.form.submit()">
                        <option value="">Any</option>
                        <option value="true" {% if selected_reimbursed == 'true' %}selected{% endif %}>Yes</option>
                        <option value="false" {% if selected_reimbursed == 'false' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-4 text-end">
                    <a class="btn btn-outline-secondary" href="#" onclick="document.location.reload();">Refresh</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: calc(100vh - 260px); overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="selectAllExpenses" onclick="toggleSelectAllExpenses()"></th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Desc</th>
                            <th>Card</th>
                            <th>Miles</th>
                            <th>Rate</th>
                            <th>Days</th>
                            <th>Total</th>
                            <th class="text-center" title="Paid for"><i class="bi bi-wallet2"></i></th>
                            <th class="text-center" title="Submitted"><i class="bi bi-send"></i></th>
                            <th class="text-center" title="Reimbursed"><i class="bi bi-cash-coin"></i></th>
                            <th>VRN</th>
                            <th class="text-center" title="Linked Transactions"><i class="bi bi-link-45deg"></i></th>
                            <th class="text-center" title="Linked Trip"><i class="bi bi-map"></i></th>
                            <th class="text-center" title="Actions"><i class="bi bi-sliders2"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set current_month = namespace(value='') %}
                        {% for e in expenses %}
                        {% if e.month != current_month.value %}
                        {% set current_month.value = e.month %}
                        {% set reimb_txn = reimbursements_by_month.get(e.month) %}
                        {% set cc_payments = cc_payments_by_month.get(e.month, []) %}
                        <tr class="table-secondary">
                            <td colspan="16" class="fw-bold">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-calendar-month"></i> {{ e.month or 'No Month' }}
                                        {% set month_expenses = expenses|selectattr('month', 'equalto', e.month)|list %}
                                        ({{ month_expenses|length }} expenses, £{{ "%.2f"|format(month_expenses|sum(attribute='total_cost')) }})
                                    </span>
                                    <div class="d-flex gap-2">
                                        {% if reimb_txn %}
                                        <a href="{{ url_for('transactions.index') }}?id={{ reimb_txn.id }}" class="btn btn-sm btn-success" title="Reimbursement transaction">
                                            <i class="bi bi-cash-coin"></i> Reimb: £{{ "%.2f"|format(reimb_txn.amount) }} ({{ reimb_txn.transaction_date.strftime('%d/%m') }})
                                        </a>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">No reimbursement</span>
                                        {% endif %}
                                        
                                        {% if cc_payments %}
                                        <div class="btn-group" role="group">
                                            {% for cc_payment in cc_payments %}
                                            <a href="{{ url_for('credit_cards.detail', id=cc_payment.credit_card_id) }}#txn-{{ cc_payment.id }}" class="btn btn-sm btn-info" title="CC Payment - {{ cc_payment.credit_card.name if cc_payment.credit_card else 'Unknown' }}">
                                                <i class="bi bi-credit-card"></i> {{ cc_payment.credit_card.name if cc_payment.credit_card else 'CC' }}: £{{ "%.2f"|format(cc_payment.amount|abs) }} ({{ cc_payment.date.strftime('%d/%m') }})
                                            </a>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        <tr id="expense-{{ e.id }}" {% if e.bank_transaction_id or e.credit_card_transaction_id %}class="table-success"{% endif %}>
                            <td><input type="checkbox" class="expense-checkbox" value="{{ e.id }}" onchange="updateExpenseBulkActions()"></td>
                            <td>{{ e.date.strftime('%d/%m/%Y') if e.date else '' }}</td>
                            <td>
                                <span class="badge {% if e.expense_type == 'Fuel' %}bg-danger{% elif e.expense_type == 'Hotel' %}bg-info{% elif e.expense_type == 'Food' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ e.expense_type }}
                                </span>
                            </td>
                            <td>{{ e.description }}</td>
                            <td>
                                {% if e.credit_card %}
                                <span class="badge bg-warning text-dark" title="{{ e.credit_card.card_name }}">
                                    <i class="bi bi-credit-card"></i> {{ e.credit_card.card_name }}
                                </span>
                                {% else %}
                                <span class="badge bg-info" title="Direct Bank Payment">
                                    <i class="bi bi-bank"></i> Bank
                                </span>
                                {% endif %}
                            </td>
                            <td>{{ e.covered_miles or '' }}</td>
                            <td>{{ e.rate_per_mile or '' }}</td>
                            <td>{{ e.days or 1 }}</td>
                            <td>£{{ "%.2f"|format((e.total_cost or e.cost or 0) ) }}</td>
                            <td class="text-center">
                                <button class="btn btn-sm toggle-flag p-0 border-0 bg-transparent {% if e.paid_for %}text-success{% else %}text-secondary{% endif %}" data-id="{{ e.id }}" data-field="paid_for" title="{% if e.paid_for %}Paid{% else %}Not paid{% endif %}">
                                    <i class="bi {% if e.paid_for %}bi-check-circle-fill{% else %}bi-circle{% endif %} fs-5"></i>
                                </button>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm toggle-flag p-0 border-0 bg-transparent {% if e.submitted %}text-success{% else %}text-secondary{% endif %}" data-id="{{ e.id }}" data-field="submitted" title="{% if e.submitted %}Submitted{% else %}Not submitted{% endif %}">
                                    <i class="bi {% if e.submitted %}bi-check-circle-fill{% else %}bi-circle{% endif %} fs-5"></i>
                                </button>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm toggle-flag p-0 border-0 bg-transparent {% if e.reimbursed %}text-success{% else %}text-secondary{% endif %}" data-id="{{ e.id }}" data-field="reimbursed" title="{% if e.reimbursed %}Reimbursed{% else %}Not reimbursed{% endif %}">
                                    <i class="bi {% if e.reimbursed %}bi-check-circle-fill{% else %}bi-circle{% endif %} fs-5"></i>
                                </button>
                            </td>
                            <td>{{ e.vehicle_registration or '' }}</td>
                            <td class="text-center">
                                {% if e.bank_transaction_id or e.credit_card_transaction_id %}
                                <div class="d-flex gap-1 justify-content-center">
                                    {% if e.bank_transaction_id %}
                                    <a href="{{ url_for('transactions.index') }}?id={{ e.bank_transaction_id }}" class="btn btn-sm btn-success" title="Bank txn #{{ e.bank_transaction_id }}">
                                        <i class="bi bi-bank"></i>
                                    </a>
                                    {% endif %}
                                    {% if e.credit_card_transaction_id %}
                                    <a href="{{ url_for('credit_cards.detail', id=e.credit_card_id) }}?txn_id={{ e.credit_card_transaction_id }}" class="btn btn-sm btn-warning text-dark" title="CC txn #{{ e.credit_card_transaction_id }}">
                                        <i class="bi bi-credit-card"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% set linked_trip = trips_dict.get(e.id) %}
                                {% if linked_trip %}
                                <a href="{{ url_for('vehicles.trips') }}#trip-{{ linked_trip.id }}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   title="Trip on {{ linked_trip.date.strftime('%d/%m/%Y') }} — {{ linked_trip.total_miles }}mi">
                                    <i class="bi bi-map"></i>
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-1 justify-content-end">
                                <button class="btn btn-sm btn-outline-primary edit-expense-btn" 
                                    title="Edit"
                                    data-id="{{ e.id }}"
                                    data-date="{{ e.date.strftime('%Y-%m-%d') if e.date else '' }}"
                                    data-description="{{ e.description or '' }}"
                                    data-type="{{ e.expense_type or '' }}"
                                    data-card="{{ e.credit_card_id or '' }}"
                                    data-account="{{ e.account_id or '' }}"
                                    data-miles="{{ e.covered_miles or '' }}"
                                    data-rate="{{ e.rate_per_mile or '' }}"
                                    data-days="{{ e.days or 1 }}"
                                    data-total="{{ e.total_cost or e.cost or 0 }}"
                                    data-vrn="{{ e.vehicle_registration or '' }}"
                                    data-paid="{{ 'true' if e.paid_for else 'false' }}"
                                    data-submitted="{{ 'true' if e.submitted else 'false' }}"
                                    data-reimbursed="{{ 'true' if e.reimbursed else 'false' }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="post" action="{{ url_for('expenses.delete_expense', expense_id=e.id) }}" style="display:contents">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Delete this expense?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if expenses|length == 0 %}
                        <tr><td colspan="15" class="text-center p-3 text-muted">No expenses found</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        <!-- Bulk Actions Panel for Expenses -->
        <div class="card mt-3 mb-4" id="expenseBulkActions" style="display:none;">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">Bulk Actions - <span id="expenseSelectedCount">0</span> selected</h6>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 align-items-center">
                    <form method="POST" action="{{ url_for('expenses.bulk_delete_linked') }}" id="expenseBulkDeleteForm" onsubmit="return confirm('Delete linked transactions for selected expenses? This will remove linked bank and card transactions.')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="expense_ids" id="expenseBulkIds">
                        <input type="hidden" name="return_url" value="{{ request.url }}">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete Linked Transactions
                        </button>
                    </form>

                    <form method="POST" action="{{ url_for('expenses.bulk_delete_expenses') }}" id="expenseBulkDeleteExpensesForm" onsubmit="return confirm('Delete selected expenses? This will remove the expense rows and any linked transactions.')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="expense_ids" id="expenseBulkIdsForDelete">
                        <input type="hidden" name="return_url" value="{{ request.url }}">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash-fill"></i> Delete Selected Expenses
                        </button>
                    </form>

                    <button type="button" class="btn btn-secondary ms-2" onclick="clearExpenseSelection()">Clear Selection</button>
                </div>
            </div>
        </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{{ url_for('expenses.add_expense') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="modal-header">
        <h5 class="modal-title">Add Expense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Type</label>
                <select name="expense_type" id="add_expense_type" class="form-select" onchange="onTypeChange('add')">
                    <option>Fuel</option>
                    <option>Hotel</option>
                    <option>Food</option>
                    <option>VAT</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Payment Method</label>
                <select name="payment_method" id="add_payment_method" class="form-select" onchange="togglePaymentFields('add')">
                    <option value="card">Credit Card</option>
                    <option value="bank">Bank Account</option>
                </select>
            </div>
            <div class="col-md-4" id="add_card_field">
                <label class="form-label">Credit Card</label>
                <select name="credit_card_id" id="add_credit_card_id" class="form-select">
                    <option value="">-- Select Card --</option>
                    {% for c in credit_cards %}
                    <option value="{{ c.id }}">{{ c.card_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4" id="add_account_field" style="display:none;">
                <label class="form-label">Bank Account</label>
                <select name="account_id" id="add_account_id" class="form-select">
                    <option value="">-- Select Account --</option>
                    {% for a in accounts %}
                    <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Covered Miles</label>
                <input type="number" step="1" name="covered_miles" id="add_covered_miles" class="form-control" onchange="calcTotal('add')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Rate (per mile)</label>
                <input type="number" step="0.01" name="rate_per_mile" id="add_rate_per_mile" class="form-control" onchange="calcTotal('add')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Days</label>
                <input type="number" name="days" id="add_days" class="form-control" value="1" onchange="calcTotal('add')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Total Cost</label>
                <input type="text" name="total_cost" id="add_total_cost" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">VRN</label>
                <input type="text" name="vehicle_registration" class="form-control">
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <div class="form-check ms-2">
                    <input class="form-check-input" type="checkbox" id="add_paid_for" name="paid_for">
                    <label class="form-check-label">Paid For</label>
                </div>
                <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="add_submitted" name="submitted">
                    <label class="form-check-label">Submitted</label>
                </div>
                <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="add_reimbursed" name="reimbursed">
                    <label class="form-check-label">Reimbursed</label>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Expense Modal (reused) -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="editExpenseForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="modal-header">
        <h5 class="modal-title">Edit Expense</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
            <input type="hidden" name="_id" id="edit_expense_id">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" name="date" id="edit_date" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Description</label>
                <input type="text" name="description" id="edit_description" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Type</label>
                <select name="expense_type" id="edit_expense_type" class="form-select" onchange="onTypeChange('edit')">
                    <option>Fuel</option>
                    <option>Hotel</option>
                    <option>Food</option>
                    <option>VAT</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Payment Method</label>
                <select name="payment_method" id="edit_payment_method" class="form-select" onchange="togglePaymentFields('edit')">
                    <option value="card">Credit Card</option>
                    <option value="bank">Bank Account</option>
                </select>
            </div>
            <div class="col-md-4" id="edit_card_field">
                <label class="form-label">Credit Card</label>
                <select name="credit_card_id" id="edit_credit_card_id" class="form-select">
                    <option value="">-- Select Card --</option>
                    {% for c in credit_cards %}
                    <option value="{{ c.id }}">{{ c.card_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4" id="edit_account_field" style="display:none;">
                <label class="form-label">Bank Account</label>
                <select name="account_id" id="edit_account_id" class="form-select">
                    <option value="">-- Select Account --</option>
                    {% for a in accounts %}
                    <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Covered Miles</label>
                <input type="number" step="1" name="covered_miles" id="edit_covered_miles" class="form-control" onchange="calcTotal('edit')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Rate (per mile)</label>
                <input type="number" step="0.01" name="rate_per_mile" id="edit_rate_per_mile" class="form-control" onchange="calcTotal('edit')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Days</label>
                <input type="number" name="days" id="edit_days" class="form-control" value="1" onchange="calcTotal('edit')">
            </div>
            <div class="col-md-2">
                <label class="form-label">Total Cost</label>
                <input type="text" name="total_cost" id="edit_total_cost" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">VRN</label>
                <input type="text" name="vehicle_registration" id="edit_vehicle_registration" class="form-control">
            </div>
            <div class="col-md-3 d-flex align-items-center">
                <div class="form-check ms-2">
                    <input class="form-check-input" type="checkbox" id="edit_paid_for" name="paid_for">
                    <label class="form-check-label">Paid For</label>
                </div>
                <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="edit_submitted" name="submitted">
                    <label class="form-check-label">Submitted</label>
                </div>
                <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="edit_reimbursed" name="reimbursed">
                    <label class="form-check-label">Reimbursed</label>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
      </form>
    </div>
  </div>
</div>

    <!-- No upload preview — entry-only UI per user request -->
<script>
function togglePaymentFields(prefix) {
    const method = document.getElementById(prefix + '_payment_method').value;
    const cardField = document.getElementById(prefix + '_card_field');
    const accountField = document.getElementById(prefix + '_account_field');
    const cardSelect = document.getElementById(prefix + '_credit_card_id');
    const accountSelect = document.getElementById(prefix + '_account_id');
    
    if (method === 'card') {
        cardField.style.display = 'block';
        accountField.style.display = 'none';
        accountSelect.value = '';  // Clear account selection
    } else {
        cardField.style.display = 'none';
        accountField.style.display = 'block';
        cardSelect.value = '';  // Clear card selection
    }
}

function calcTotal(prefix) {
    const miles = parseFloat(document.getElementById(prefix + '_covered_miles').value || 0);
    const rate = parseFloat(document.getElementById(prefix + '_rate_per_mile').value || 0);
    const days = parseInt(document.getElementById(prefix + '_days').value || 1);
    const totalField = document.getElementById(prefix + '_total_cost');
    if (miles && rate) {
        const total = (miles * rate * days).toFixed(2);
        totalField.value = total;
    }
}

function onTypeChange(prefix) {
    // For non-fuel types, don't auto-calc total
    // (we leave total to be entered manually)
}

// Toggle flags via AJAX
document.addEventListener('DOMContentLoaded', function(){
    // Edit expense with data attributes
    document.querySelectorAll('.edit-expense-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const date = this.dataset.date;
            const description = this.dataset.description;
            const type = this.dataset.type;
            const cardId = this.dataset.card;
            const accountId = this.dataset.account;
            const miles = this.dataset.miles;
            const rate = this.dataset.rate;
            const days = this.dataset.days;
            const total = this.dataset.total;
            const vrn = this.dataset.vrn;
            const paid = this.dataset.paid === 'true';
            const submitted = this.dataset.submitted === 'true';
            const reimbursed = this.dataset.reimbursed === 'true';
            
            document.getElementById('editExpenseForm').action = `/expenses/update/${id}`;
            document.getElementById('edit_expense_id').value = id;
            document.getElementById('edit_date').value = date;
            document.getElementById('edit_description').value = description;
            document.getElementById('edit_expense_type').value = type;
            
            // Set payment method based on what's populated
            if (cardId) {
                document.getElementById('edit_payment_method').value = 'card';
                document.getElementById('edit_credit_card_id').value = cardId;
                document.getElementById('edit_account_id').value = '';
            } else if (accountId) {
                document.getElementById('edit_payment_method').value = 'bank';
                document.getElementById('edit_account_id').value = accountId;
                document.getElementById('edit_credit_card_id').value = '';
            } else {
                document.getElementById('edit_payment_method').value = 'bank';
                document.getElementById('edit_credit_card_id').value = '';
                document.getElementById('edit_account_id').value = '';
            }
            togglePaymentFields('edit');
            
            document.getElementById('edit_covered_miles').value = miles || '';
            document.getElementById('edit_rate_per_mile').value = rate || '';
            document.getElementById('edit_days').value = days || 1;
            document.getElementById('edit_total_cost').value = total || '';
            document.getElementById('edit_vehicle_registration').value = vrn || '';
            document.getElementById('edit_paid_for').checked = paid;
            document.getElementById('edit_submitted').checked = submitted;
            document.getElementById('edit_reimbursed').checked = reimbursed;
            new bootstrap.Modal(document.getElementById('editExpenseModal')).show();
        });
    });
    
    // Toggle flags
    document.querySelectorAll('.toggle-flag').forEach(btn => {
        btn.addEventListener('click', function(e){
            const id = this.dataset.id;
            const field = this.dataset.field;
            fetch(`/expenses/toggle/${id}/${field}`, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    const val = data.value;
                    const icon = this.querySelector('i');
                    if (val) {
                        this.classList.remove('text-secondary');
                        this.classList.add('text-success');
                        if (icon) { icon.classList.remove('bi-circle'); icon.classList.add('bi-check-circle-fill'); }
                        this.title = field === 'reimbursed' ? 'Reimbursed' : field === 'submitted' ? 'Submitted' : 'Paid';
                    } else {
                        this.classList.remove('text-success');
                        this.classList.add('text-secondary');
                        if (icon) { icon.classList.remove('bi-check-circle-fill'); icon.classList.add('bi-circle'); }
                        this.title = field === 'reimbursed' ? 'Not reimbursed' : field === 'submitted' ? 'Not submitted' : 'Not paid';
                    }
                    // row highlight toggle for reimbursed
                    const tr = this.closest('tr');
                    if (field === 'reimbursed') {
                        if (val) tr.classList.add('table-success'); else tr.classList.remove('table-success');
                    }
                }).catch(err => { alert('Toggle failed'); });
        });
    });
});

// Bulk selection helpers for expenses
function toggleSelectAllExpenses() {
    const sel = document.getElementById('selectAllExpenses');
    document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = sel.checked);
    updateExpenseBulkActions();
}

function updateExpenseBulkActions() {
    const checked = document.querySelectorAll('.expense-checkbox:checked');
    const count = checked.length;
    const panel = document.getElementById('expenseBulkActions');
    const badge = document.getElementById('expenseSelectedCount');
    badge.textContent = count;
    if (count > 0) {
        panel.style.display = 'block';
        const ids = Array.from(checked).map(cb => cb.value).join(',');
        // Populate both hidden inputs so either bulk form receives the IDs
        const bulkIds = document.getElementById('expenseBulkIds');
        if (bulkIds) bulkIds.value = ids;
        const bulkIdsForDelete = document.getElementById('expenseBulkIdsForDelete');
        if (bulkIdsForDelete) bulkIdsForDelete.value = ids;
    } else {
        panel.style.display = 'none';
    }
}

function clearExpenseSelection() {
    document.getElementById('selectAllExpenses').checked = false;
    document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = false);
    updateExpenseBulkActions();
}
</script>

<!-- Sync All Modal -->
<div class="modal fade" id="generateAllModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Sync Transactions</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('expenses.generate_all') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="modal-body">
        <p>Runs the full sync workflow in the correct order:</p>
        <ol>
          <li><strong>Reimbursements</strong> &mdash; groups submitted expenses by period, creates a single reimbursement transaction on the last working day</li>
          <li><strong>CC Payments</strong> &mdash; 1 working day after each reimbursement, creates a payment transaction per card to clear the balance</li>
        </ol>
        <p class="text-muted small mb-3">This also runs automatically when you add or edit an expense.</p>
        <div class="mb-0">
          <label class="form-label">Period <span class="text-muted fw-normal">(optional &mdash; leave blank for all periods)</span></label>
          <input type="month" name="year_month" class="form-control" placeholder="2026-01">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success"><i class="bi bi-arrow-repeat"></i> Run Sync</button>
      </div>
      </form>
    </div>
  </div>
</div>

<script>
// Highlight and scroll to specific expense if ID is in URL
{% if highlight_expense_id %}
window.addEventListener('load', function() {
    const targetRow = document.getElementById('expense-{{ highlight_expense_id }}');
    if (targetRow) {
        // Add highlight styling
        targetRow.classList.add('editing-highlight');
        
        // Scroll to expense with smooth behavior
        setTimeout(function() {
            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
        
        // Remove highlight after 5 seconds
        setTimeout(function() {
            targetRow.style.transition = 'all 2s ease';
            targetRow.classList.remove('editing-highlight');
        }, 5000);
    }
});
{% endif %}
</script>

{% endblock %}
