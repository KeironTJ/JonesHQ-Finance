{% extends "base.html" %}

{% block title %}Add Recurring Income - JonesHQ Finance{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-plus-circle"></i> Add Recurring Income</h1>
            <p class="text-muted">Set up automatic monthly income generation</p>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="person" class="form-label">Person</label>
                            <select class="form-select" id="person" name="person" required>
                                <option value="Keiron" selected>Keiron</option>
                                <option value="Emma">Emma</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="source" class="form-label">Source (Employer)</label>
                            <input type="text" class="form-control" id="source" name="source" 
                                   placeholder="e.g., My Company Ltd" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                            <small class="text-muted">Leave empty for ongoing income</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="pay_day" class="form-label">Pay Day of Month</label>
                            <select class="form-select" id="pay_day" name="pay_day" required>
                                <option value="0">Last day of month</option>
                                {% for day in range(1, 32) %}
                                <option value="{{ day }}" {% if day == 15 %}selected{% endif %}>{{ day }}{{ 'st' if day in [1, 21, 31] else ('nd' if day in [2, 22] else ('rd' if day in [3, 23] else 'th')) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label for="gross_annual" class="form-label">Annual Salary</label>
                    <div class="input-group">
                        <span class="input-group-text">£</span>
                        <input type="number" step="0.01" class="form-control" id="gross_annual" 
                               name="gross_annual" placeholder="53000.00" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="tax_code" class="form-label">Tax Code</label>
                    <input type="text" class="form-control" id="tax_code" name="tax_code" 
                           placeholder="1257L" value="1257L" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="employer_pension_pct" class="form-label">Employer Pension %</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" 
                                       id="employer_pension_pct" name="employer_pension_pct" 
                                       placeholder="3.00" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="employee_pension_pct" class="form-label">Employee Pension %</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" 
                                       id="employee_pension_pct" name="employee_pension_pct" 
                                       placeholder="4.00" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="avc" class="form-label">AVC (Monthly)</label>
                            <div class="input-group">
                                <span class="input-group-text">£</span>
                                <input type="number" step="0.01" class="form-control" 
                                       id="avc" name="avc" placeholder="0.00" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="other" class="form-label">Other Deductions (Monthly)</label>
                            <div class="input-group">
                                <span class="input-group-text">£</span>
                                <input type="number" step="0.01" class="form-control" 
                                       id="other" name="other" placeholder="0.00" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="deposit_account_id" class="form-label">Deposit Account</label>
                    <select class="form-select" id="deposit_account_id" name="deposit_account_id" required>
                        <option value="">Select account...</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}">{{ account.name }} ({{ account.account_type }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="category_id" class="form-label">Category</label>
                    <select class="form-select" id="category_id" name="category_id">
                        <option value="">-- Select Category --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">
                            {% if category.head_budget and category.sub_budget %}
                                {{ category.head_budget }} > {{ category.sub_budget }}
                            {% else %}
                                {{ category.name }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="use_manual_deductions" 
                               name="use_manual_deductions" onchange="toggleManualFields()">
                        <label class="form-check-label" for="use_manual_deductions">
                            <strong>Use Manual Values (from payslip)</strong>
                        </label>
                        <div class="form-text">Check this to enter actual values from your payslip instead of calculated amounts</div>
                    </div>
                </div>
                
                <div id="manual_fields" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Enter the actual monthly values from your payslip
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manual_tax_monthly" class="form-label">Income Tax (Monthly)</label>
                                <div class="input-group">
                                    <span class="input-group-text">£</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="manual_tax_monthly" name="manual_tax_monthly" 
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manual_ni_monthly" class="form-label">National Insurance (Monthly)</label>
                                <div class="input-group">
                                    <span class="input-group-text">£</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="manual_ni_monthly" name="manual_ni_monthly" 
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manual_employee_pension" class="form-label">Employee Pension (Monthly)</label>
                                <div class="input-group">
                                    <span class="input-group-text">£</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="manual_employee_pension" name="manual_employee_pension" 
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manual_employer_pension" class="form-label">Employer Pension (Monthly)</label>
                                <div class="input-group">
                                    <span class="input-group-text">£</span>
                                    <input type="number" step="0.01" class="form-control" 
                                           id="manual_employer_pension" name="manual_employer_pension" 
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manual_take_home" class="form-label">Take Home Pay (Monthly)</label>
                        <div class="input-group">
                            <span class="input-group-text">£</span>
                            <input type="number" step="0.01" class="form-control" 
                                   id="manual_take_home" name="manual_take_home" 
                                   placeholder="0.00">
                        </div>
                        <div class="form-text">This is your net pay after all deductions</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="auto_create_transaction" 
                               name="auto_create_transaction" checked>
                        <label class="form-check-label" for="auto_create_transaction">
                            Automatically create transactions for each income
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="2" 
                              placeholder="Additional notes about this income..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Auto-Generation:</strong> When you save this recurring income, the system will automatically 
                    generate income records from the start date up to the current month. You can then click 
                    "Generate Missing Income" anytime to create records for new months.
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Recurring Income
                    </button>
                    <a href="{{ url_for('income.recurring') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleManualFields() {
    const useManual = document.getElementById('use_manual_deductions').checked;
    document.getElementById('manual_fields').style.display = useManual ? 'block' : 'none';
}
</script>
{% endblock %}
