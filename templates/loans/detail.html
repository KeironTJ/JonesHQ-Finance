{% extends "base.html" %}

{% block title %}{{ loan.name }} - Loan Details{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-bank"></i> {{ loan.name }}
            {% if loan.is_active %}
            <span class="badge bg-success">Active</span>
            {% else %}
            <span class="badge bg-secondary">Inactive</span>
            {% endif %}
        </h1>
        <div>
            <a href="{{ url_for('loans.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Loans
            </a>
            <a href="{{ url_for('loans.edit', id=loan.id) }}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Edit Loan
            </a>
        </div>
    </div>

    <!-- Loan Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Original Amount</h6>
                    <h3>£{{ "%.2f"|format(loan.loan_value) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="text-muted">Current Balance</h6>
                    <h3 class="text-danger">£{{ "%.2f"|format(loan.current_balance) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Monthly Payment</h6>
                    <h3>£{{ "%.2f"|format(loan.monthly_payment) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">APR</h6>
                    <h3>{{ "%.2f"|format(loan.annual_apr) }}%</h3>
                    <small class="text-muted">{{ "%.2f"|format(loan.monthly_apr) }}% monthly</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Loan Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th>Start Date:</th>
                            <td>{{ loan.start_date.strftime('%d %b %Y') }}</td>
                        </tr>
                        <tr>
                            <th>End Date:</th>
                            <td>{{ loan.end_date.strftime('%d %b %Y') }}</td>
                        </tr>
                        <tr>
                            <th>Term:</th>
                            <td>{{ loan.term_months }} months</td>
                        </tr>
                        <tr>
                            <th>Remaining:</th>
                            <td>{{ remaining_months }} months</td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td>{{ loan.created_at.strftime('%d %b %Y %H:%M') }}</td>
                        </tr>
                        {% if loan.updated_at %}
                        <tr>
                            <th>Last Updated:</th>
                            <td>{{ loan.updated_at.strftime('%d %b %Y %H:%M') }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Payment Statistics</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th>Total Payments:</th>
                            <td>{{ stats.total_payments }} (<span class="badge bg-success">{{ stats.paid_count }}</span> paid, <span class="badge bg-warning">{{ stats.unpaid_count }}</span> pending)</td>
                        </tr>
                        <tr>
                            <th colspan="2" class="bg-light"><strong>Paid to Date</strong></th>
                        </tr>
                        <tr>
                            <th>Amount Paid:</th>
                            <td><strong>£{{ "%.2f"|format(stats.total_amount_paid) }}</strong></td>
                        </tr>
                        <tr>
                            <th>Interest Paid:</th>
                            <td class="text-danger">£{{ "%.2f"|format(stats.total_interest_paid) }}</td>
                        </tr>
                        <tr>
                            <th>Principal Paid:</th>
                            <td class="text-success">£{{ "%.2f"|format(stats.total_principal_paid) }}</td>
                        </tr>
                        <tr>
                            <th colspan="2" class="bg-light"><strong>Remaining</strong></th>
                        </tr>
                        <tr>
                            <th>Amount Remaining:</th>
                            <td><strong>£{{ "%.2f"|format(stats.remaining_amount) }}</strong></td>
                        </tr>
                        <tr>
                            <th>Interest Remaining:</th>
                            <td class="text-danger">£{{ "%.2f"|format(stats.remaining_interest) }}</td>
                        </tr>
                        <tr>
                            <th>Principal Remaining:</th>
                            <td class="text-success">£{{ "%.2f"|format(stats.remaining_principal) }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <h6>Loan Progress</h6>
            {% set progress = ((loan.loan_value - loan.current_balance) / loan.loan_value * 100) if loan.loan_value > 0 else 0 %}
            <div class="progress" style="height: 30px;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: {{ progress }}%;" 
                     aria-valuenow="{{ progress }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    <strong>{{ "%.1f"|format(progress) }}% Paid Off</strong>
                </div>
            </div>
            <small class="text-muted">
                £{{ "%.2f"|format(loan.loan_value - loan.current_balance) }} of £{{ "%.2f"|format(loan.loan_value) }} repaid
            </small>
        </div>
    </div>

    <!-- Generate Schedule Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Payment Schedule Management</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Generate New Schedule</h6>
                    <p class="text-muted">Create payment schedule from loan start date</p>
                    <form method="POST" action="{{ url_for('loans.generate_schedule', id=loan.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="end_date_generate" class="form-label">End Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="end_date_generate" 
                                   name="end_date" 
                                   value="{{ loan.end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        <button type="submit" class="btn btn-success" onclick="return confirm('Generate payment schedule?')">
                            <i class="bi bi-calendar-check"></i> Generate Schedule
                        </button>
                    </form>
                </div>
                <div class="col-md-6">
                    <h6>Regenerate Schedule</h6>
                    <p class="text-muted">Delete future payments and regenerate from today</p>
                    <form method="POST" action="{{ url_for('loans.regenerate_schedule', id=loan.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="end_date_regenerate" class="form-label">End Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="end_date_regenerate" 
                                   name="end_date" 
                                   value="{{ loan.end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        <button type="submit" class="btn btn-warning" onclick="return confirm('Delete all future payments and regenerate?')">
                            <i class="bi bi-arrow-repeat"></i> Regenerate Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Schedule -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar3"></i> Payment Schedule ({{ payments|length }} payments)</h5>
                {% if payments %}
                <div>
                    <button type="button" class="btn btn-sm btn-light" id="selectAllPayments">
                        <i class="bi bi-check-square"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" id="deleteSelectedPayments">
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if payments %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="30"><input type="checkbox" id="selectAllCheckbox"></th>
                            <th>Period</th>
                            <th>Date</th>
                            <th>Opening Balance</th>
                            <th>Payment</th>
                            <th>Interest</th>
                            <th>Principal</th>
                            <th>Closing Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr class="{{ 'table-success' if payment.is_paid else '' }}">
                            <td>
                                <input type="checkbox" class="payment-checkbox" value="{{ payment.id }}">
                            </td>
                            <td><strong>{{ payment.period }}</strong></td>
                            <td>{{ payment.date.strftime('%d %b %Y') }}</td>
                            <td>£{{ "%.2f"|format(payment.opening_balance) }}</td>
                            <td><strong>£{{ "%.2f"|format(payment.payment_amount) }}</strong></td>
                            <td class="text-danger">£{{ "%.2f"|format(payment.interest_charge) }}</td>
                            <td class="text-success">£{{ "%.2f"|format(payment.amount_paid_off) }}</td>
                            <td>
                                <strong>£{{ "%.2f"|format(payment.closing_balance) }}</strong>
                            </td>
                            <td>
                                {% if payment.is_paid %}
                                <span class="badge bg-success">Paid</span>
                                {% else %}
                                <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary toggle-paid" 
                                        data-loan-id="{{ loan.id }}"
                                        data-payment-id="{{ payment.id }}"
                                        data-is-paid="{{ payment.is_paid|lower }}"
                                        title="Toggle paid status">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                {% if not payment.is_paid or payment.period == 0 %}
                                <button class="btn btn-sm btn-outline-warning" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editPaymentModal{{ payment.id }}"
                                        title="Edit payment">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% endif %}
                                <form method="POST" 
                                      action="{{ url_for('loans.delete_payment', id=loan.id, payment_id=payment.id) }}" 
                                      style="display: inline;"
                                      onsubmit="return confirm('Delete this payment?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete payment">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="4">Scheduled Totals</th>
                            <th>£{{ "%.2f"|format(stats.total_amount_scheduled) }}</th>
                            <th class="text-danger">£{{ "%.2f"|format(stats.total_interest_scheduled) }}</th>
                            <th class="text-success">£{{ "%.2f"|format(stats.total_principal_scheduled) }}</th>
                            <th colspan="3"></th>
                        </tr>
                        <tr class="table-success">
                            <th colspan="4">Paid to Date</th>
                            <th>£{{ "%.2f"|format(stats.total_amount_paid) }}</th>
                            <th class="text-danger">£{{ "%.2f"|format(stats.total_interest_paid) }}</th>
                            <th class="text-success">£{{ "%.2f"|format(stats.total_principal_paid) }}</th>
                            <th colspan="3"></th>
                        </tr>
                        <tr class="table-warning">
                            <th colspan="4">Remaining</th>
                            <th>£{{ "%.2f"|format(stats.remaining_amount) }}</th>
                            <th class="text-danger">£{{ "%.2f"|format(stats.remaining_interest) }}</th>
                            <th class="text-success">£{{ "%.2f"|format(stats.remaining_principal) }}</th>
                            <th colspan="3"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                <p class="mt-3">No payment schedule generated yet</p>
                <p>Click "Generate Schedule" above to create the payment schedule</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Payment Modals -->
{% for payment in payments %}
{% if not payment.is_paid or payment.period == 0 %}
<div class="modal fade" id="editPaymentModal{{ payment.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Payment - Period {{ payment.period }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('loans.edit_payment', id=loan.id, payment_id=payment.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" name="payment_date" 
                               value="{{ payment.date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Amount (£)</label>
                        <input type="number" step="0.01" class="form-control" name="payment_amount" 
                               value="{{ '%.2f'|format(payment.payment_amount) }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Interest Charge (£)</label>
                        <input type="number" step="0.01" class="form-control" name="interest_charge" 
                               value="{{ '%.2f'|format(payment.interest_charge) }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Principal Paid Off (£)</label>
                        <input type="number" step="0.01" class="form-control" name="amount_paid_off" 
                               value="{{ '%.2f'|format(payment.amount_paid_off) }}">
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Opening Balance:</strong> £{{ "%.2f"|format(payment.opening_balance) }}<br>
                            <strong>Period:</strong> {{ payment.period }}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle toggle paid status
    document.querySelectorAll('.toggle-paid').forEach(button => {
        button.addEventListener('click', function() {
            const loanId = this.dataset.loanId;
            const paymentId = this.dataset.paymentId;
            const isPaid = this.dataset.isPaid === 'true';
            
            fetch(`/loans/${loanId}/payment/${paymentId}/toggle-paid`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating payment status: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        });
    });
    
    // Select All checkbox
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectAllButton = document.getElementById('selectAllPayments');
    const deleteSelectedButton = document.getElementById('deleteSelectedPayments');
    const paymentCheckboxes = document.querySelectorAll('.payment-checkbox');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            paymentCheckboxes.forEach(cb => cb.checked = this.checked);
        });
    }
    
    if (selectAllButton) {
        selectAllButton.addEventListener('click', function() {
            const allChecked = Array.from(paymentCheckboxes).every(cb => cb.checked);
            paymentCheckboxes.forEach(cb => cb.checked = !allChecked);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = !allChecked;
            }
        });
    }
    
    if (deleteSelectedButton) {
        deleteSelectedButton.addEventListener('click', function() {
            const selectedIds = Array.from(paymentCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one payment to delete');
                return;
            }
            
            if (confirm(`Delete ${selectedIds.length} payment(s)? This will also delete linked bank transactions.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("loans.bulk_delete_payments", id=loan.id) }}';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'payment_ids';
                input.value = selectedIds.join(',');
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
});
</script>
{% endblock %}
