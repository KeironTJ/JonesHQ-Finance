{% extends "base.html" %}

{% block title %}Dashboard - JonesHQ Finance{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <div>
            <a href="{{ url_for('settings.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-gear"></i> Settings
            </a>
        </div>
    </div>

    {% if not selected_account %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> 
        <strong>No Account Selected</strong><br>
        Please create a "Joint" type account to track payday periods, or select an account below.
    </div>
    {% endif %}

    <!-- Account Selector -->
    {% if accounts %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-bank"></i> Account Selection</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('dashboard.index') }}" class="row g-3">
                <div class="col-md-10">
                    <select name="account_id" class="form-select" onchange="this.form.submit()">
                        <option value="">Select an account to track...</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if selected_account and account.id == selected_account.id %}selected{% endif %}>
                            {{ account.name }} ({{ account.account_type }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-arrow-repeat"></i> Update
                    </button>
                </div>
            </form>
            {% if selected_account %}
            <div class="mt-3">
                <strong>Tracking:</strong> {{ selected_account.name }} 
                <span class="badge bg-info">{{ selected_account.account_type }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Payday Period Tracking -->
    {% if payday_data %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-calendar-check"></i> Payday Period Tracking 
                <small class="ms-2">(Payday: {{ payday_day }}{{ 'st' if payday_day == 1 or payday_day == 21 or payday_day == 31 else 'nd' if payday_day == 2 or payday_day == 22 else 'rd' if payday_day == 3 or payday_day == 23 else 'th' }} of each month)</small>
            </h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">
                <i class="bi bi-info-circle"></i> 
                Showing projected balances from payday to payday, including both paid and unpaid transactions. 
                If payday falls on a weekend, it's adjusted to the previous working day.
            </p>
            
            <!-- Payday Periods Accordion -->
            <div class="accordion" id="paydayAccordion">
                {% for period in payday_data %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button {% if loop.index > 1 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.index == 1 %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div>
                                    <strong class="me-2">{{ period.period_label }}</strong>
                                    <span class="text-muted small">{{ period.start_date.strftime('%d %b') }} - {{ period.end_date.strftime('%d %b %Y') }}</span>
                                    {% if loop.index == 1 %}
                                        <span class="badge bg-success ms-2">Current Period</span>
                                    {% endif %}
                                </div>
                                <div class="d-flex gap-4">
                                    <div class="text-center">
                                        <div class="text-muted small">Ending Balance</div>
                                        <strong class="text-primary">£{{ "%.2f"|format(period.rolling_balance) }}</strong>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted small">Minimum</div>
                                        <strong class="text-warning">£{{ "%.2f"|format(period.min_balance) }}</strong>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted small">Extra Spend</div>
                                        <strong class="text-info">£{{ "%.2f"|format(period.max_extra_spend) }}</strong>
                                    </div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.index == 1 %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#paydayAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center py-2">
                                            <div class="text-muted small">Opening Balance</div>
                                            <strong>£{{ "%.2f"|format(period.opening_balance) }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-primary bg-opacity-10">
                                        <div class="card-body text-center py-2">
                                            <div class="text-muted small">Ending Balance</div>
                                            <strong class="text-primary">£{{ "%.2f"|format(period.rolling_balance) }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning bg-opacity-10">
                                        <div class="card-body text-center py-2">
                                            <div class="text-muted small">Minimum Balance</div>
                                            <strong class="text-warning">£{{ "%.2f"|format(period.min_balance) }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info bg-opacity-10">
                                        <div class="card-body text-center py-2">
                                            <div class="text-muted small">Safe Extra Spend</div>
                                            <strong class="text-info">£{{ "%.2f"|format(period.max_extra_spend) }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if period.category_breakdown %}
                            {% set period_idx = loop.index %}
                            
                            <!-- Income Section -->
                            {% if period.category_breakdown.income %}
                            <h6 class="mt-4 mb-3"><i class="bi bi-arrow-down-circle text-success me-2"></i>Income by Category</h6>
                            <div class="accordion" id="incomeAccordion{{ period_idx }}">
                                {% for cat in period.category_breakdown.income %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="incomeHeading{{ period_idx }}_{{ loop.index }}">
                                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#incomeCollapse{{ period_idx }}_{{ loop.index }}" aria-expanded="false" aria-controls="incomeCollapse{{ period_idx }}_{{ loop.index }}">
                                            <div class="d-flex justify-content-between w-100 me-3">
                                                <span><i class="bi bi-tag-fill text-success me-2"></i>{{ cat.category }}</span>
                                                <strong class="text-success">£{{ "%.2f"|format(cat.total) }}</strong>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="incomeCollapse{{ period_idx }}_{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="incomeHeading{{ period_idx }}_{{ loop.index }}" data-bs-parent="#incomeAccordion{{ period_idx }}">
                                        <div class="accordion-body py-2">
                                            <table class="table table-sm table-hover mb-0">
                                                <tbody>
                                                    {% for subcat in cat.subcategories %}
                                                    <tr>
                                                        <td><i class="bi bi-caret-right-fill text-muted small me-2"></i>{{ subcat.name }}</td>
                                                        <td class="text-end text-success">£{{ "%.2f"|format(subcat.amount) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Expenses Section -->
                            {% if period.category_breakdown.expenses %}
                            <h6 class="mt-4 mb-3"><i class="bi bi-arrow-up-circle text-danger me-2"></i>Expenses by Category</h6>
                            <div class="accordion" id="expenseAccordion{{ period_idx }}">
                                {% for cat in period.category_breakdown.expenses %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="expenseHeading{{ period_idx }}_{{ loop.index }}">
                                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#expenseCollapse{{ period_idx }}_{{ loop.index }}" aria-expanded="false" aria-controls="expenseCollapse{{ period_idx }}_{{ loop.index }}">
                                            <div class="d-flex justify-content-between w-100 me-3">
                                                <span><i class="bi bi-tag-fill text-danger me-2"></i>{{ cat.category }}</span>
                                                <strong class="text-danger">£{{ "%.2f"|format(cat.total) }}</strong>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="expenseCollapse{{ period_idx }}_{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="expenseHeading{{ period_idx }}_{{ loop.index }}" data-bs-parent="#expenseAccordion{{ period_idx }}">
                                        <div class="accordion-body py-2">
                                            <table class="table table-sm table-hover mb-0">
                                                <tbody>
                                                    {% for subcat in cat.subcategories %}
                                                    <tr>
                                                        <td><i class="bi bi-caret-right-fill text-muted small me-2"></i>{{ subcat.name }}</td>
                                                        <td class="text-end text-danger">£{{ "%.2f"|format(subcat.amount) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if not period.category_breakdown.income and not period.category_breakdown.expenses %}
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-info-circle"></i> No transactions in this period
                            </div>
                            {% endif %}
                            
                            {% else %}
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-info-circle"></i> No transactions in this period
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Legend -->
            <div class="alert alert-light mt-4 mb-0">
                <div class="row">
                    <div class="col-md-3">
                        <strong class="text-primary"><i class="bi bi-circle-fill"></i> Rolling Balance:</strong><br>
                        <small>Expected balance at end of period</small>
                    </div>
                    <div class="col-md-3">
                        <strong class="text-warning"><i class="bi bi-circle-fill"></i> MIN Balance:</strong><br>
                        <small>Lowest point during the period</small>
                    </div>
                    <div class="col-md-3">
                        <strong class="text-info"><i class="bi bi-circle-fill"></i> Max Extra Spend:</strong><br>
                        <small>Growth from start to end of period</small>
                    </div>
                    <div class="col-md-3">
                        <strong><i class="bi bi-info-circle"></i> Note:</strong><br>
                        <small>Includes unpaid transactions</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Links -->
    <div class="row">
        <div class="col-md-3 mb-3">
            <a href="{{ url_for('transactions.index') }}" class="text-decoration-none">
                <div class="card border-primary h-100 hover-shadow">
                    <div class="card-body text-center">
                        <i class="bi bi-receipt display-4 text-primary"></i>
                        <h5 class="card-title mt-3">Transactions</h5>
                        <p class="card-text text-muted">Manage income & expenses</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a href="{{ url_for('accounts.index') }}" class="text-decoration-none">
                <div class="card border-success h-100 hover-shadow">
                    <div class="card-body text-center">
                        <i class="bi bi-bank display-4 text-success"></i>
                        <h5 class="card-title mt-3">Accounts</h5>
                        <p class="card-text text-muted">Bank accounts overview</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a href="{{ url_for('credit_cards.index') }}" class="text-decoration-none">
                <div class="card border-danger h-100 hover-shadow">
                    <div class="card-body text-center">
                        <i class="bi bi-credit-card display-4 text-danger"></i>
                        <h5 class="card-title mt-3">Credit Cards</h5>
                        <p class="card-text text-muted">Track card balances</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a href="{{ url_for('loans.index') }}" class="text-decoration-none">
                <div class="card border-warning h-100 hover-shadow">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-coin display-4 text-warning"></i>
                        <h5 class="card-title mt-3">Loans</h5>
                        <p class="card-text text-muted">Manage loan payments</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<style>
.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
    transition: all 0.3s ease;
}
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>
{% endblock %}
